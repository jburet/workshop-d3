<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
  <script src="lib/js/d3.v3.min.js"></script>
  <script src="lib/js/queue.v1.min.js"></script>
  <script src="lib/js/colorbrewer.js"></script>
</head>
<body>
  <div id="my-dataviz"/>
</body>

<style>
  .overlay {
    fill: none;
    pointer-events: all;
  }

  .carto_label{
  	font: 18px sans-serif;
  }

  .axis_y{
    font: 16px sans-serif;
  }
  .axis_y path,
  .axis_y line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .axis_x{
    font: 16px sans-serif;
  }
  .axis_x path,
	.axis_x line {
	  fill: none;
	  stroke: #000;
	  shape-rendering: crispEdges;
	}

  .grid .tick {
	    stroke: lightgrey;
	    opacity: 1;
	}

	.grid path {
	    stroke-width: 0;
	}

  .bar{
    stroke: black;
  }
</style>

<script>


var carto = function(container){
  // Define some var for dimension and margin
  var margin = {top: 10, right: 10, bottom: 10, left: 10},
      width = 700 - margin.left - margin.right,
      height = 700 - margin.top - margin.bottom;

  // Initialise SVG canvas
  var svg = d3.select(container).append("svg")
      .attr("width", width)
      .attr("height", height);

  // Define a linear color scale
  // https://github.com/mbostock/d3/wiki/Quantitative-Scales#linear
  var colorScale = colorbrewer.RdYlGn[5]
  var absDomain = [0, 0.17, 0.23, 0.28, 0.38, 0.68]
  color = d3.scale.linear()
          .domain(absDomain)
          .range(colorScale);

  // Create a geo path
  // https://github.com/mbostock/d3/wiki/Geo-Paths#path
  //
  // Create a projection (lambert-93)
  // Center map (2.454071, 47.279229)
  // define a scale (3800)
  // and translate map
  var path = d3.geo.path()
  var projection = d3.geo.conicConformal() // Lambert-93
      .center([2.454071, 47.279229]) // On centre la carte sur la France
      .scale(3800)
      .translate([width / 2, height / 2]);
  path.projection(projection);

  // create a map
  var abs = d3.map()
  // load data
  queue()
    .defer(d3.json, "data/json/COMMUNE.json" )
    .defer(d3.csv, "data/csv/abstention.csv", function(d) { abs.set(d.id, d); })
    .await(ready)

   // Function called when data loaded
   function ready(error, root) {

      // 1. Map data to path
      // 2. Use root.features as data
      // 3. add a fill function for coloring cities
      var deps =
      svg.append("g")
        .attr("id", "abs")

      deps.selectAll("path")
        .data(root.features)
        .enter().append("path")
        .attr('fill', function(d) {
              var c = abs.get(d.properties.INSEE_COM)
              if(c){
                return color(c.ab/c.ins);
              }
              return "black"
          })
        .attr("d", path)

        // Create legend
        // 1. Use selector and enter() on color scale data. Foreach color append a rect
         svg.selectAll('scale').data(colorScale)
         .enter()
         .append('rect')
           .attr('x', function(d,i){return 10})
           .attr('y', function(d,i){return (height-margin.bottom-150) - ((i*30)+10)})
           .attr('width', 20)
           .attr('height', 20)
           .style('fill', function(d){return d})
           .style('stroke', 'black')

        // 2. Create text
        svg.selectAll('scale').data(colorScale)
          .enter()
          .append('text')
            .attr('class', 'carto_label')
            .attr('x', function(d,i){return 40})
            .attr('y', function(d,i){return (height-margin.bottom-133) - ((i*30)+10)})
            .text(function(d,i){return (absDomain[i]*100).toFixed(0) + ' % - '+(absDomain[i+1]*100).toFixed(0)+' %'})


       // Optionnal: Add zoom and translate behavior
       // https://github.com/mbostock/d3/wiki/Zoom-Behavior#zoom
       var zoom = d3.behavior.zoom()
         .translate([0, 0])
         .scale(1)
         .scaleExtent([1, 16])
         .on("zoom", zoomed);

       function zoomed() {
         deps.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
       }

       // Use this overlay manager zoom event
       svg.append("rect")
         .attr("class", "overlay")
         .attr("width", width)
         .attr("height", height)
         .call(zoom);
       }
}

carto('#my-dataviz')


</script>
</html>
