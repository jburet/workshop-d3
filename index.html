<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
  <script src="lib/js/d3.v3.min.js"></script>
  <script src="lib/js/queue.v1.min.js"></script>
  <script src="lib/js/colorbrewer.js"></script>
</head>
<body>
  <div id="my-dataviz"/>
  <div id="my-dataviz-2"/>
</body>

<style>
  .overlay {
    fill: none;
    pointer-events: all;
  }

  .carto_label{
  	font: 18px sans-serif;
  }

  .axis_y{
    font: 16px sans-serif;
  }
  .axis_y path,
  .axis_y line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .axis_x{
    font: 16px sans-serif;
  }
  .axis_x path,
	.axis_x line {
	  fill: none;
	  stroke: #000;
	  shape-rendering: crispEdges;
	}

  .grid .tick {
	    stroke: lightgrey;
	    opacity: 1;
	}

	.grid path {
	    stroke-width: 0;
	}

  .bar{
    stroke: black;
  }
</style>

<script>


var carto = function(container){
  var margin = {top: 10, right: 10, bottom: 10, left: 10},
      width = 700 - margin.left - margin.right,
      height = 700 - margin.top - margin.bottom;

      var svg = d3.select(container).append("svg")
          .attr("width", width)
          .attr("height", height);

      var colorScale = colorbrewer.RdYlGn[5]
      var absDomain = [0, 0.17, 0.23, 0.28, 0.38, 0.68]
      //var absDomain = [0.68,0.5, 0.38, 0.28, 0.23, 0.17]
      /*var color = d3.scale.ordinal()
        .domain(0,68, 0)
        .range(colorbrewer.RdYlGn[9]);*/
        color = d3.scale.linear()
                .domain(absDomain)
                .range(colorScale);
      var path = d3.geo.path()
      var projection = d3.geo.conicConformal() // Lambert-93
          .center([2.454071, 47.279229]) // On centre la carte sur la France
          .scale(3800)
          .translate([width / 2, height / 2]);

      path.projection(projection);


      var deps = svg
        .append("g")
        .attr("id", "abs");

      var abs = d3.map()
      queue()
        .defer(d3.json, "data/json/COMMUNE.json" )
        .defer(d3.csv, "data/csv/abstention.csv", function(d) { abs.set(d.id, d); })
        .await(ready)

     svg.selectAll('scale').data(colorScale)
     .enter()
     .append('rect')
       .attr('x', function(d,i){return 10})
       .attr('y', function(d,i){return (height-margin.bottom-150) - ((i*30)+10)})
       .attr('width', 20)
       .attr('height', 20)
       .style('fill', function(d){return d})
       .style('stroke', 'black')
       .on("mouseover", overfunction)

    svg.selectAll('scale').data(colorScale)
      .enter()
      .append('text')
        .attr('class', 'carto_label')
        .attr('x', function(d,i){return 40})
        .attr('y', function(d,i){return (height-margin.bottom-133) - ((i*30)+10)})
        .text(function(d,i){return (absDomain[i]*100).toFixed(0) + ' % - '+(absDomain[i+1]*100).toFixed(0)+' %'})

     function overfunction(){

     }

     function ready(error, root) {
        var zoom = d3.behavior.zoom()
          .translate([0, 0])
          .scale(1)
          .scaleExtent([1, 16])
          .on("zoom", zoomed);

        function zoomed() {
          deps.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
          //features.select(".state-border").style("stroke-width", 1.5 / d3.event.scale + "px");
          //features.select(".county-border").style("stroke-width", .5 / d3.event.scale + "px");
        }

        deps.selectAll("path")
          .data(root.features)
          .enter().append("path")
          .attr('fill', function(d) {
                var c = abs.get(d.properties.INSEE_COM)
                if(c){
                  return color(c.ab/c.ins);
                }
                return "black"
            })
          .attr("d", path)

        svg.append("rect")
          .attr("class", "overlay")
          .attr("width", width)
          .attr("height", height)
          .call(zoom);
      }
}


var distrib = function(container){
  var margin = {top: 50, right: 50, bottom: 100, left: 100},
	    width = 800 - margin.left - margin.right,
	    height = 400 - margin.top - margin.bottom;

  var svg = d3.select(container).append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  .append("g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  d3.csv("data/csv/abstention.csv", function(error, data){

  var quantize = d3.scale.quantize().domain([0,100]).range(d3.range(0,100,5))
  var quantizeColor = d3.scale.quantize().domain([0,100]).range(colorbrewer.YlOrRd[9])
  var histo = d3.map()
  data.forEach(function(entry) {
    var key = quantize((parseInt(entry.ab)*100/parseInt(entry.ins)))
    if(!histo.has(key)){
      histo.set(key, 0)
    }
    histo.set(key, histo.get(key)+1)
  });

  var y = d3.scale.linear().range([height,0]);
  y.domain([0, d3.max(histo.values())]);
  var axey = d3.svg.axis().scale(y).orient('left');
  svg.append('g').attr('class', 'axis_y').call(axey).append('text').attr('transform', 'rotate(-90)').attr('y', 6).attr('dy', '0.8em').style('text-anchor', 'end').text('Abstention')

  var x = d3.scale.ordinal().rangeRoundBands([0,width]);
  console.log(histo.keys())
  x.domain(histo.keys().sort(function(a,b){return a-b}));
  var axex = d3.svg.axis().scale(x).orient('bottom');
  var xaxis = svg.append('g').attr('class', 'axis_x').attr('transform', 'translate(0,' + height + ')').call(axex);
  xaxis.selectAll('text').style('text-anchor', 'end').attr('dx', '-.8em').attr('dy', '.15em').attr('transform', function () {
    return 'rotate(-60)';
  });

  var ygrid = d3.svg.axis().scale(y).orient('left');
  svg.append('g').attr('class', 'grid').call(ygrid.tickSize(-width, 0, 0).tickFormat(''));



  svg.selectAll('.bar').data(histo.keys())
  .enter().append('rect')
  .style('fill', function(d){return quantizeColor(d)})
  .attr('class', 'bar')
  .attr('x', function (d) {
      return x(d);
  })
  .attr('width', x.rangeBand())
  .attr('y', function (d) {
      return y(histo.get(d));
  })
  .attr('height', function (d) {
      return height - y(histo.get(d));
  });
  })
}

distrib('#my-dataviz-2')


</script>
</html>
